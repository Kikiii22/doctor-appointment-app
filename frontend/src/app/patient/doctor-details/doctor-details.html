<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<div class="d-flex vh-100 bg-light">
  <!-- Sidebar -->
  <nav class="sidebar d-flex flex-column flex-shrink-0 p-3 text-white">
    <div class="d-flex align-items-center mb-3 text-white text-decoration-none">
      <i class="fas fa-user-md fs-3 me-2"></i>
      <span class="fs-4 fw-bold">Patient Panel</span>
    </div>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a routerLink="/patient/doctors" class="nav-link text-white">
          <i class="fas fa-search me-2"></i> Find Doctors
        </a>
      </li>
      <li>
        <a routerLink="/patient/appointments" class="nav-link text-white">
          <i class="fas fa-calendar-check me-2"></i> My Appointments
        </a>
      </li>
    </ul>
    <hr>

    <div class="mt-auto pt-3 border-top">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center text-white">
          <i class="fas fa-user-circle me-2 fs-4"></i>
          <strong>{{ currentUser?.username || 'Guest' }}</strong>
        </div>
        <button class="btn btn-outline-light btn-sm" (click)="logout()">
          <i class="fas fa-right-from-bracket me-1"></i> Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <div class="content flex-grow-1 p-4">
    <div class="d-flex align-items-center mb-3">
      <button class="btn btn-link text-decoration-none me-2" (click)="goBack()">
        <i class="fas fa-arrow-left me-1"></i> Back
      </button>
      <h2 class="mb-0">Doctor Details</h2>
    </div>

    <div class="row g-4">
      <!-- Doctor card -->
      <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-start">
              <div class="me-3">
                <div class="avatar-circle">
                  <i class="fas fa-user-doctor"></i>
                </div>
              </div>

              <div class="flex-grow-1">
                <h4 class="card-title mb-2">Dr. {{ doctor?.fullName || '—' }}</h4>

                <div class="d-flex flex-wrap gap-2 mb-3">
                  <span class="badge bg-secondary" *ngIf="doctor?.department?.name">
                    {{ doctor?.department?.name }}
                  </span>
                  <span class="badge bg-info text-dark" *ngIf="hospitalName && hospitalName !== '—'">
                    <i class="fas fa-hospital me-1"></i> {{ hospitalName }}
                  </span>
                </div>

                <div class="small text-muted">
                  <div class="d-flex align-items-center mb-2" *ngIf="doctor?.phone">
                    <i class="fas fa-phone me-2"></i>
                    <span>{{ doctor?.phone }}</span>
                  </div>
                  <div class="d-flex align-items-center" *ngIf="doctor?.user?.email">
                    <i class="fas fa-envelope me-2"></i>
                    <span>{{ doctor?.user?.email }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Next Available -->
            <div *ngIf="earliestSlot" class="mt-4 p-3 rounded border-start next-available">
              <div class="fw-semibold small">Next Available</div>
              <div class="text-muted small mb-2">
                {{ earliestSlot?.date }} at {{ earliestSlot?.startTime || '—' }}
              </div>
              <button class="btn btn-primary btn-sm" (click)="bookSlot(earliestSlot!)">
                <i class="far fa-calendar-plus me-1"></i> Book Now
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendar Section -->
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
            <div>
              <i class="far fa-calendar-alt me-2"></i> Appointment Calendar
            </div>
            <div class="small">
              <span class="badge bg-success me-1">Available</span>
              <span class="badge bg-secondary">Booked</span>
            </div>
          </div>

          <div class="card-body p-3">
            <!-- Calendar Navigation -->
            <div class="d-flex align-items-center justify-content-between mb-4">
              <button class="nav-button" (click)="previousMonth()">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="month-year-display">
                {{ currentCalendarDate | date:'MMMM yyyy' }}
              </div>
              <button class="nav-button" (click)="nextMonth()">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>

            <!-- Calendar -->
            <div class="calendar-container">
              <!-- Calendar Header -->
              <div class="calendar-header">
                <div class="calendar-header-day">Sun</div>
                <div class="calendar-header-day">Mon</div>
                <div class="calendar-header-day">Tue</div>
                <div class="calendar-header-day">Wed</div>
                <div class="calendar-header-day">Thu</div>
                <div class="calendar-header-day">Fri</div>
                <div class="calendar-header-day">Sat</div>
              </div>

              <!-- Calendar Grid -->
              <div class="calendar-grid">
                <div
                  *ngFor="let day of calendarDays"
                  class="calendar-day"
                  [class.other-month]="!day.isCurrentMonth"
                  [class.today]="day.isToday"
                  [class.past-date]="isDateInPast(day.dateISO)"
                  [class.selected]="selectedDateISO === day.dateISO">

                  <div class="day-number">{{ day.dayNumber }}</div>

                  <!-- Show "Past" indicator for past dates -->
                  <div *ngIf="isDateInPast(day.dateISO) && day.isCurrentMonth" class="past-indicator">
                    <small class="text-muted">Past</small>
                  </div>

                  <!-- Slots for this day -->
                  <div *ngFor="let slot of day.slots" class="slot-container">
                    <button
                      class="slot-item"
                      [class.available]="isAvailable(slot)"
                      [class.booked]="!isAvailable(slot)"
                      [class.past]="isSlotInPast(slot)"
                      [disabled]="!isAvailable(slot)"
                      (click)="bookSlot(slot)"
                      [title]="getSlotTooltip(slot)">
                      {{ timeOf(slot) }}
                    </button>
                  </div>

                  <!-- No slots message for current/future dates -->
                  <div *ngIf="!day.loading && day.slots.length === 0 && !isDateInPast(day.dateISO) && day.isCurrentMonth"
                       class="no-slots-indicator">
                    <small class="text-muted">No slots</small>
                  </div>

                  <!-- Loading indicator for specific day -->
                  <div *ngIf="day.loading" class="d-flex justify-content-center mt-1">
                    <div class="spinner-border spinner-border-sm" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading overlay for entire calendar -->
            <div *ngIf="loadingSlots" class="d-flex justify-content-center my-4">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading calendar...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
